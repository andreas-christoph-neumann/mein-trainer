<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
    <title>Svenska Trainer</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        :root { --primary: #0051a8; --accent: #ffcd00; --bg: #f4f4f4; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100dvh; }
        header { background: var(--primary); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        #app { flex: 1; display: flex; flex-direction: column; padding: 1rem; overflow-y: auto; }
        .card { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; margin-bottom: 1rem; }
        .word-de { font-size: 1.5rem; color: #666; }
        .controls { padding: 1rem; background: white; border-top: 1px solid #ddd; }
        .helper-bar { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }
        .helper-btn { padding: 10px 15px; font-size: 1.2rem; border: 1px solid #ccc; border-radius: 5px; background: #eee; }
        input { width: 100%; padding: 15px; font-size: 1.1rem; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .action-btn { width: 100%; padding: 15px; margin-top: 10px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1.1rem; }
        .hidden { display: none; }
        .feedback { margin-top: 10px; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

<header>
    <div>
        <span id="stats">L√§dt...</span>
        <button onclick="forceUpdate()" style="background: #ff4444; color: white; border: none; padding: 5px 8px; border-radius: 5px; font-size: 0.7rem; margin-left: 10px;">
            Reset
        </button>
    </div>
    <button onclick="toggleView()" id="viewBtn">Vokabeln hinzuf√ºgen</button>
</header>

<div id="app">
    <div id="learn-view">
        <div class="card">
            <div class="word-de" id="display-de">Keine f√§lligen Vokabeln!</div>
            <div id="feedback-area" class="feedback"></div>
        </div>
    </div>

    <div id="add-view" class="hidden">
        <h2>Neue Vokabel</h2>
        <input type="text" id="input-sv" placeholder="Schwedisch (z.B. √Ñpplet)" autocapitalize="sentences" spellcheck="false">
        <input type="text" id="input-de" placeholder="Deutsch (z.B. Der Apfel)" style="margin-top:10px" autocapitalize="sentences" spellcheck="false">
        <button class="action-btn" onclick="addVocab()">Speichern</button>
    </div>
        <div id="manage-view" class="hidden">
            <h2>Vokabeln verwalten</h2>
            <div id="vocab-list"></div>
        </div>
    </div>

<div class="controls" id="input-controls">
    <div class="helper-bar">
        <button class="helper-btn" onclick="addChar('√•')">√•</button>
        <button class="helper-btn" onclick="addChar('√§')">√§</button>
        <button class="helper-btn" onclick="addChar('√∂')">√∂</button>
    </div>
    <input type="text" id="user-input" placeholder="√úbersetzung tippen..." autocomplete="off" autocapitalize="sentences" spellcheck="false">
    <button class="action-btn" id="check-btn" onclick="checkAnswer()">Pr√ºfen</button>
</div>

<script>
    // 1. Service Worker Registrierung
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').then(reg => {
            reg.onupdatefound = () => {
                const worker = reg.installing;
                worker.onstatechange = () => {
                    if (worker.state === 'installed' && navigator.serviceWorker.controller) {
                        if (confirm('Neue Version verf√ºgbar! App jetzt aktualisieren?')) {
                            window.location.reload();
                        }
                    }
                };
            };
        });
    }

    // 2. Datenbank Setup
    const db = new Dexie('VocabTrainerDB');
    db.version(1).stores({ 
        items: '++id, deckId, termSource, termTarget, srs.dueDate' 
    });

    let currentItem = null;

    // 3. Logik-Funktionen
    function getLevenshtein(a, b) {
        const matrix = [];
        for (let i = 0; i <= b.length; i++) matrix[i] = [i];
        for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
        for (let i = 1; i <= b.length; i++) {
            for (let j = 1; j <= a.length; j++) {
                if (b.charAt(i - 1) === a.charAt(j - 1)) matrix[i][j] = matrix[i - 1][j - 1];
                else matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j] + 1);
            }
        }
        return matrix[b.length][a.length];
    }

    function calculateSM2(item, quality) {
        let { reps, interval, easeFactor } = item.srs;
        if (quality >= 3) {
            if (reps === 0) interval = 1;
            else if (reps === 1) interval = 6;
            else interval = Math.round(interval * easeFactor);
            reps++;
        } else {
            reps = 0; interval = 1;
        }
        easeFactor = Math.max(1.3, easeFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02)));
        return { reps, interval, easeFactor, dueDate: Date.now() + interval * 24 * 60 * 60 * 1000 };
    }

    function speak(text) {
        const ut = new SpeechSynthesisUtterance(text);
        ut.lang = 'sv-SE';
        ut.rate = 0.9;
        window.speechSynthesis.speak(ut);
    }

    // 4. UI-Aktionen
    async function loadNextItem() {
        try {
            const due = await db.items.where('srs.dueDate').below(Date.now()).toArray();
            const allCount = await db.items.count();
            document.getElementById('stats').innerText = `F√§llig: ${due.length} | Gesamt: ${allCount}`;
        
            if (allCount === 0) {
                document.getElementById('display-de').innerText = "Bitte f√ºge Vokabeln hinzu!";
                if (document.getElementById('add-view').classList.contains('hidden')) toggleView();
                return;
            }

            currentItem = due.length > 0 ? due[0] : null;
            document.getElementById('display-de').innerText = currentItem ? currentItem.termSource : "Alles erledigt! üéâ";
            document.getElementById('user-input').value = "";
            document.getElementById('feedback-area').innerText = "";
        } catch (e) {
            console.error(e);
            document.getElementById('stats').innerText = "DB-Fehler!";
        }
    }

    async function checkAnswer() {
        if (!currentItem) return;
        const input = document.getElementById('user-input').value.trim();
        const dist = getLevenshtein(input.toLowerCase(), currentItem.termTarget.toLowerCase());
        
        let quality = dist === 0 ? 5 : (dist === 1 ? 4 : (dist === 2 ? 3 : 0));
        const newSrs = calculateSM2(currentItem, quality);
        
        await db.items.update(currentItem.id, { srs: newSrs });
        speak(currentItem.termTarget);
        
        const feedback = document.getElementById('feedback-area');
        feedback.innerText = quality >= 3 ? `Richtig! (${currentItem.termTarget})` : `Falsch: ${currentItem.termTarget}`;
        feedback.style.color = quality >= 3 ? "green" : "red";

        setTimeout(loadNextItem, 2000);
    }

   async function addVocab() {
        // Reihenfolge der Zuweisung getauscht
        const sv = document.getElementById('input-sv').value;
        const de = document.getElementById('input-de').value;
    
        if (!de || !sv) return;

        try {
            await db.items.add({
                deckId: 1,
                termSource: de, // Deutsch bleibt Quellsprache f√ºr die Abfrage
                termTarget: sv, // Schwedisch bleibt das Ziel [cite: 17, 73]
                srs: { reps: 0, interval: 0, easeFactor: 2.5, dueDate: Date.now() }
            });

            document.getElementById('input-de').value = "";
            document.getElementById('input-sv').value = "";
            toggleView();
            await loadNextItem(); 
        } catch (error) {
            alert("Speicherfehler!");
        }
    }

    function addChar(c) { 
        const input = document.getElementById('user-input');
        input.value += c; 
        input.focus(); 
    }

    function toggleView() {
        const isAdd = document.getElementById('add-view').classList.toggle('hidden');
        document.getElementById('manage-view').classList.toggle('hidden', !isAdd); // Zeigt Liste im Add-Modus
        document.getElementById('learn-view').classList.toggle('hidden', !isAdd);
        document.getElementById('input-controls').classList.toggle('hidden', !isAdd);
        document.getElementById('viewBtn').innerText = isAdd ? "Vokabeln verwalten" : "Zum Lernen";
        if (isAdd) renderList();
    }

    async function forceUpdate() {
        if (confirm("Cache l√∂schen und neu laden?")) {
            const regs = await navigator.serviceWorker.getRegistrations();
            for (let r of regs) await r.unregister();
            const keys = await caches.keys();
            await Promise.all(keys.map(k => caches.delete(k)));
            window.location.reload(true);
        }
    }

    // Liste anzeigen
    async function renderList() {
        const allItems = await db.items.toArray();
        const listDiv = document.getElementById('vocab-list');
        listDiv.innerHTML = allItems.map(item => `
            <div style="background: white; margin-bottom: 5px; padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                <span><strong>${item.termSource}</strong> - ${item.termTarget}</span>
                <div>
                    <button onclick="editVocab(${item.id})" style="background: var(--accent); border: none; padding: 5px; border-radius: 3px;">Edit</button>
                    <button onclick="deleteVocab(${item.id})" style="background: #ff4444; color: white; border: none; padding: 5px; border-radius: 3px; margin-left: 5px;">X</button>
                </div>
            </div>
        `).join('');
    }

    // L√∂schen
    async function deleteVocab(id) {
        if (confirm("L√∂schen?")) {
            await db.items.delete(id);
            renderList();
            loadNextItem();
        }
    }

    // Korrigieren (l√§dt Daten zur√ºck ins Formular)
    async function editVocab(id) {
        const item = await db.items.get(id);
        document.getElementById('input-de').value = item.termSource;
        document.getElementById('input-sv').value = item.termTarget;
        // L√∂scht das alte Item, damit das neue beim Speichern als "Update" fungiert
        await db.items.delete(id); 
        toggleView(); // Wechselt zum Formular
    }

    window.speechSynthesis.getVoices();
    loadNextItem();
</script>
</body>
</html>