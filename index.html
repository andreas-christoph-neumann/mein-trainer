<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
    <title>Svenska Trainer</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        :root {
            --primary: #0051a8;
            --accent: #ffcd00;
            --grammar: #7f8c8d;
            /* Light Mode Colors */
            --bg: #f4f4f4;
            --card-bg: #ffffff;
            --text: #333333;
            --input-border: #dddddd;
            --control-bg: #ffffff;
            --list-item-bg: #ffffff;
            --list-border: #eeeeee;
            --edit-bg: #fffde7;
        }

        body.dark-mode {
            /* Dark Mode Colors */
            --bg: #121212;
            --card-bg: #1e1e1e;
            --text: #e0e0e0;
            --input-border: #333333;
            --control-bg: #1e1e1e;
            --list-item-bg: #1e1e1e;
            --list-border: #2c2c2c;
            --edit-bg: #2d2a16;
        }

        body { font-family: sans-serif; margin: 0; background: var(--bg); color: var(--text); display: flex; flex-direction: column; height: 100dvh; transition: background 0.3s, color 0.3s; }
        header { background: var(--primary); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        #app { flex: 1; display: flex; flex-direction: column; padding: 1rem; overflow-y: auto; }
        
        .card { background: var(--card-bg); padding: 1.5rem; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; margin-bottom: 1rem; transition: background 0.3s; }
        .word-prompt { font-size: 1.8rem; font-weight: bold; color: var(--text); margin-bottom: 5px; line-height: 1.2; word-break: break-word; }
        
        .badge-container { display: flex; justify-content: center; gap: 4px; flex-wrap: wrap; margin-top: 8px; }
        .badge { padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; color: white; font-weight: bold; text-transform: uppercase; }
        .bg-grammar { background-color: var(--grammar); }
        
        .controls { padding: 1rem; background: var(--control-bg); border-top: 1px solid var(--input-border); transition: background 0.3s; }
        .helper-bar { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }
        .helper-btn { padding: 8px 12px; font-size: 1rem; border: 1px solid var(--input-border); border-radius: 5px; background: var(--bg); color: var(--text); }
        
        input { width: 100%; padding: 10px; font-size: 1rem; border: 2px solid var(--input-border); border-radius: 8px; box-sizing: border-box; margin-bottom: 5px; background: var(--bg); color: var(--text); }
        .action-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; }
        .next-btn { background: #4caf50; margin-top: 0; }
        .hidden { display: none; }
        
        .err-char { color: #ff4444; text-decoration: underline; font-weight: bold; }
        .err-missing { color: #ff4444; font-weight: bold; }
        .err-extra { color: #ff4444; text-decoration: line-through; opacity: 0.7; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-box { background: var(--card-bg); color: var(--text); padding: 1.5rem; border-radius: 15px; width: 85%; max-width: 400px; text-align: center; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 8px; border: none; font-size: 1rem; cursor: pointer; }

        #vocab-list .vocab-item { border-bottom: 1px solid var(--list-border); padding: 10px; background: var(--list-item-bg); margin-bottom: 5px; border-radius: 5px; }
        .inline-edit-box { display: flex; flex-direction: column; gap: 5px; background: var(--edit-bg) !important; padding: 10px; border: 1px solid var(--accent); border-radius: 8px; }
        .inline-btn { flex: 1; padding: 8px; border-radius: 5px; border: none; font-size: 0.8rem; cursor: pointer; }
        
        #theme-toggle { background: none; border: none; color: white; font-size: 1.4rem; cursor: pointer; padding: 5px; }
        .list-btn { background: none; border: none; font-size: 1.1rem; cursor: pointer; padding: 5px; color: var(--text); }
    </style>
</head>
<body class="light-mode">

<header>
    <div style="display:flex; align-items:center;">
        <button id="theme-toggle" onclick="toggleTheme()" title="Farbschema umschalten">üåô</button>
        <span id="stats" style="margin-left:10px">L√§dt...</span>
    </div>
    <button onclick="toggleView()" id="viewBtn" style="background:rgba(255,255,255,0.2); border:1px solid white; color:white; padding:5px 10px; border-radius:5px;">Verwalten</button>
</header>

<div id="app">
    <div id="learn-view">
        <div class="card">
            <div id="direction-label" style="font-size: 0.9rem; color: var(--primary); margin-bottom: 8px; font-weight: bold;"></div>
            <div class="word-prompt" id="display-prompt">Lade Vokabeln...</div>
            <div id="display-badges" class="badge-container"></div>
            <div id="feedback-area" style="margin-top: 15px; font-weight: bold; min-height: 1.5em; line-height: 1.6;"></div>
        </div>
    </div>

    <div id="add-view" class="hidden">
        <h3>Vokabeln verwalten</h3>
        <input type="text" id="input-sv" placeholder="Schwedisch">
        <input type="text" id="input-de" placeholder="Deutsch">
        <input type="text" id="input-tags" placeholder="Zusatzinfo (z.B. II, schw.)">
        <button class="action-btn" onclick="addVocab()">Speichern</button>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="action-btn" style="background:#666; font-size: 0.8rem;" onclick="exportData()">Export</button>
            <button class="action-btn" style="background:#666; font-size: 0.8rem;" onclick="document.getElementById('importFile').click()">Import</button>
            <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(event)">
        </div>
        
        <button class="action-btn" style="background:#d35400; font-size: 0.8rem; margin-top: 10px;" onclick="customConfirm('Alle Daten wirklich l√∂schen?', () => db.items.clear().then(loadNextItem))">Alles l√∂schen</button>

        <h3 style="margin-top:25px">Vokabelliste</h3>
        <input type="text" id="search-input" placeholder="Suchen..." oninput="renderList()">
        <div id="vocab-list"></div>
    </div>
</div>

<div class="controls" id="input-controls">
    <div class="helper-bar">
        <button class="helper-btn" onclick="addChar('√•')">√•</button>
        <button class="helper-btn" onclick="addChar('√§')">√§</button>
        <button class="helper-btn" onclick="addChar('√∂')">√∂</button>
    </div>
    <input type="text" id="user-input" placeholder="Deine Antwort..." autocomplete="off">
    <button class="action-btn" id="check-btn" onclick="checkAnswer()">Pr√ºfen</button>
    <button class="action-btn next-btn hidden" id="next-btn" onclick="loadNextItem()">Weiter</button>
</div>

<script>
    const db = new Dexie('VocabTrainerDB');
    db.version(1).stores({ items: '++id, termSource, termTarget, direction, tags, srs.dueDate' });

    let currentItem = null;
    let inlineEditingId = null;

    // Theme Management
    function initTheme() {
        const saved = localStorage.getItem('theme');
        const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (saved === 'dark' || (!saved && systemDark)) {
            document.body.classList.add('dark-mode');
            document.getElementById('theme-toggle').innerText = '‚òÄÔ∏è';
        }
    }

    function toggleTheme() {
        const isDark = document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        document.getElementById('theme-toggle').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
    }

    function cleanString(str) {
        if (!str) return "";
        return str.replace(/[\u200B-\u200D\uFEFF]/g, '').replace(/\s+/g, ' ').trim();
    }

    function customConfirm(message, onConfirm) {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        overlay.innerHTML = `<div class="modal-box"><p>${message}</p><div class="modal-btns"><button class="modal-btn" id="modal-yes" style="background:var(--primary); color:white;">Ja</button><button class="modal-btn" id="modal-no" style="background:#666; color:white;">Abbrechen</button></div></div>`;
        document.body.appendChild(overlay);
        overlay.querySelector('#modal-yes').onclick = () => { onConfirm(); overlay.remove(); };
        overlay.querySelector('#modal-no').onclick = () => overlay.remove();
    }

    function calculateSRS(item, correct) {
        let currentStage = (item.srs && item.srs.stage) ? item.srs.stage : 1;
        const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        if (!correct) return { stage: 1, dueDate: 0 };
        let nextStage = currentStage + 1;
        let msToAdd = (nextStage === 2) ? rand(20, 50) * 3600000 : 
                      (nextStage === 3) ? rand(5, 10) * 86400000 :
                      (nextStage === 4) ? rand(12, 16) * 86400000 :
                      (nextStage === 5) ? rand(25, 35) * 86400000 :
                      rand(150, 200) * Math.pow(2, nextStage - 6) * 86400000;
        return { stage: nextStage, dueDate: Date.now() + msToAdd };
    }

    function speak(text) {
        const ut = new SpeechSynthesisUtterance(text.split('/')[0]);
        ut.lang = 'sv-SE'; ut.rate = 0.9;
        window.speechSynthesis.speak(ut);
    }

    function getDiffHtml(input, target) {
        let result = ""; let i = 0, j = 0;
        const s1 = input.toLowerCase(); const s2 = target.toLowerCase();
        while (i < s1.length || j < s2.length) {
            if (i < s1.length && j < s2.length && s1[i] === s2[j]) { result += input[i]; i++; j++; }
            else if (i < s1.length && j < s2.length && s1[i] !== s2[j]) {
                if (s1[i+1] === s2[j]) { result += `<span class="err-extra">${input[i]}</span>`; i++; }
                else if (s1[i] === s2[j+1]) { result += `<span class="err-missing">_</span>`; j++; }
                else { result += `<span class="err-char">${input[i]}</span>`; i++; j++; }
            } else if (i < s1.length) { result += `<span class="err-extra">${input[i]}</span>`; i++; }
            else if (j < s2.length) { result += `<span class="err-missing">_</span>`; j++; }
        }
        return result;
    }

    function getLevenshtein(a, b) {
        const matrix = Array.from({ length: a.length + 1 }, () => []);
        for (let i = 0; i <= a.length; i++) matrix[i][0] = i;
        for (let j = 0; j <= b.length; j++) matrix[0][j] = j;
        for (let i = 1; i <= a.length; i++) {
            for (let j = 1; j <= b.length; j++) {
                const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                matrix[i][j] = Math.min(matrix[i - 1][j] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j - 1] + cost);
            }
        }
        return matrix[a.length][b.length];
    }

    function getProgressIcon(stage = 1) {
        const colors = ['#ff4444', '#ff9800', '#ffeb3b', '#90EE90', '#006400'];
        const coloredCount = Math.min(Math.max(stage - 1, 0), 5);
        let svg = `<svg width="16" height="8" viewBox="0 0 7.5 4" style="vertical-align: middle; margin-right: 6px;">`;
        for (let i = 0; i < 5; i++) {
            const color = i < coloredCount ? colors[i] : (document.body.classList.contains('dark-mode') ? '#444' : '#ccc');
            svg += `<rect x="${i * 1.5}" y="${4 - (i + 1) * 0.8}" width="1" height="${(i + 1) * 0.8}" fill="${color}" />`;
        }
        return svg + `</svg>`;
    }

    async function loadNextItem() {
        document.getElementById('check-btn').classList.remove('hidden');
        document.getElementById('next-btn').classList.add('hidden');
        document.getElementById('check-btn').disabled = false;
        document.getElementById('user-input').value = ""; 
        document.getElementById('feedback-area').innerText = "";
        const due = await db.items.where('srs.dueDate').below(Date.now()).toArray();
        const allCount = await db.items.count();
        document.getElementById('stats').innerText = `F√§llig: ${due.length} | Gesamt: ${allCount}`;
        currentItem = due.length > 0 ? due[Math.floor(Math.random() * due.length)] : null;
        if (currentItem) {
            const promptEl = document.getElementById('display-prompt');
            promptEl.innerText = currentItem.termSource;
            promptEl.style.fontSize = currentItem.termSource.length > 25 ? "1.1rem" : currentItem.termSource.length > 15 ? "1.4rem" : "1.8rem";
            document.getElementById('display-badges').innerHTML = (currentItem.tags || "").split(',').map(t => `<span class="badge bg-grammar">${t.trim()}</span>`).join('');
            document.getElementById('direction-label').innerHTML = getProgressIcon(currentItem.srs.stage) + (currentItem.direction === 'de-sv' ? " DE ‚ûî SV" : " SV ‚ûî DE");
        } else {
            document.getElementById('display-prompt').innerText = allCount > 0 ? "Pause! üéâ" : "Bitte Vokabeln importieren!";
            document.getElementById('display-badges').innerHTML = ""; document.getElementById('direction-label').innerHTML = "";
        }
    }

    async function checkAnswer() {
        if (!currentItem) return;
        const rawInput = document.getElementById('user-input').value;
        const input = cleanString(rawInput).toLowerCase();
        const targets = currentItem.termTarget.split('/').map(t => cleanString(t));
        const allPossibleVariants = [];
        
        targets.forEach(t => {
            const withParens = cleanString(t.replace(/[()]/g, '')).toLowerCase();
            const withoutParens = cleanString(t.replace(/\([^)]*\)/g, '')).toLowerCase();
            allPossibleVariants.push(withParens);
            if (withoutParens !== withParens) allPossibleVariants.push(withoutParens);
        });

        const isCorrect = allPossibleVariants.includes(input);
        await db.items.update(currentItem.id, { srs: calculateSRS(currentItem, isCorrect) });
        if (currentItem.direction === 'de-sv') speak(currentItem.termTarget); else speak(currentItem.termSource);
        
        const feedback = document.getElementById('feedback-area');
        if (isCorrect) {
            feedback.innerHTML = `<span style="color: #4caf50;">Richtig!</span><br><small>L√∂sung: ${currentItem.termTarget}</small>`;
            document.getElementById('check-btn').disabled = true; setTimeout(loadNextItem, 2000);
        } else {
            let bestMatch = allPossibleVariants[0]; let minScore = 999;
            allPossibleVariants.forEach(v => { let s = getLevenshtein(input, v); if (s < minScore) { minScore = s; bestMatch = v; } });
            feedback.innerHTML = `<span style="color: #ff4444;">Falsch.</span><br>Eingabe: ${getDiffHtml(cleanString(rawInput), bestMatch)}<br><small>L√∂sung: ${currentItem.termTarget}</small>`;
            document.getElementById('check-btn').classList.add('hidden'); document.getElementById('next-btn').classList.remove('hidden');
        }
    }

    async function addVocab() {
        const sv = cleanString(document.getElementById('input-sv').value);
        const de = cleanString(document.getElementById('input-de').value);
        const tags = cleanString(document.getElementById('input-tags').value);
        if (!sv || !de) return;
        const srs = { stage: 1, dueDate: 0 };
        await db.items.add({ termSource: de, termTarget: sv, direction: 'de-sv', tags, srs });
        await db.items.add({ termSource: sv, termTarget: de, direction: 'sv-de', tags, srs });
        document.getElementById('input-sv').value = ""; document.getElementById('input-de').value = ""; document.getElementById('input-tags').value = "";
        renderList(); loadNextItem();
    }

    async function renderList() {
        const query = document.getElementById('search-input').value.toLowerCase();
        let items = await db.items.toArray();
        if (query) { items = items.filter(i => (i.termSource || "").toLowerCase().includes(query) || (i.termTarget || "").toLowerCase().includes(query) || (i.tags && i.tags.toLowerCase().includes(query))); }
        document.getElementById('vocab-list').innerHTML = items.map(i => {
            if (!i.termSource || !i.termTarget) return ""; 
            if (inlineEditingId === i.id) {
                return `<div class="vocab-item inline-edit-box"><input type="text" id="edit-src-${i.id}" value="${i.termSource}"><input type="text" id="edit-trg-${i.id}" value="${i.termTarget}"><input type="text" id="edit-tags-${i.id}" value="${i.tags || ''}"><div style="display:flex;gap:5px"><button class="inline-btn" style="background:#4caf50;color:white" onclick="saveInline(${i.id})">OK</button><button class="inline-btn" style="background:#666;color:white" onclick="inlineEditingId=null;renderList()">X</button></div></div>`;
            }
            const badges = (i.tags || "").split(',').map(t => `<span class="badge bg-grammar">${t.trim()}</span>`).join('');
            return `<div class="vocab-item" style="display:flex; justify-content:space-between; align-items:center;"><div><div>${getProgressIcon(i.srs.stage)} <strong>${i.termSource}</strong></div><div style="font-size:0.9rem;opacity:0.8">${i.termTarget}</div><div style="margin-top:4px;">${badges}</div></div><div><button class="list-btn" onclick="inlineEditingId=${i.id};renderList()">‚úé</button><button class="list-btn" onclick="customConfirm('Eintrag l√∂schen?', () => db.items.delete(${i.id}).then(renderList))" style="color:#ff4444;">‚úï</button></div></div>`;
        }).join('');
    }

    async function saveInline(id) {
        await db.items.update(id, { termSource: cleanString(document.getElementById(`edit-src-${id}`).value), termTarget: cleanString(document.getElementById(`edit-trg-${id}`).value), tags: cleanString(document.getElementById(`edit-tags-${id}`).value) });
        inlineEditingId = null; renderList(); loadNextItem();
    }

    async function exportData() { const items = await db.items.toArray(); const blob = new Blob([JSON.stringify(items)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'backup.json'; a.click(); }
    
    async function importData(e) {
        const reader = new FileReader();
        reader.onload = async (ev) => {
            try {
                const data = JSON.parse(ev.target.result);
                for (const entry of data) {
                    if (entry.termSource && entry.termTarget) {
                        entry.termSource = cleanString(entry.termSource); entry.termTarget = cleanString(entry.termTarget); entry.tags = cleanString(entry.tags);
                        await db.items.add(entry);
                    } else if (entry.sv && entry.de) { // Support f√ºr altes Format
                        const srs = { stage: 1, dueDate: 0 };
                        await db.items.add({ termSource: cleanString(entry.de), termTarget: cleanString(entry.sv), direction: 'de-sv', tags: cleanString(entry.tags), srs });
                        await db.items.add({ termSource: cleanString(entry.sv), termTarget: cleanString(entry.de), direction: 'sv-de', tags: cleanString(entry.tags), srs });
                    }
                }
                renderList(); loadNextItem();
            } catch (err) { alert("Fehler beim Import."); }
        };
        reader.readAsText(e.target.files[0]);
    }

    function addChar(c) { const i = document.getElementById('user-input'); i.value += c; i.focus(); }
    function toggleView() { 
        const isHidden = document.getElementById('add-view').classList.toggle('hidden'); 
        document.getElementById('learn-view').classList.toggle('hidden'); 
        document.getElementById('input-controls').classList.toggle('hidden'); 
        document.getElementById('viewBtn').innerText = isHidden ? "Verwalten" : "Lernen";
        renderList(); 
    }
    initTheme();
    loadNextItem();
</script>
</body>
</html>