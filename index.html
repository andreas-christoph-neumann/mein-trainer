<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
    <title>Svenska Trainer</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        :root { --primary: #0051a8; --accent: #ffcd00; --bg: #f4f4f4; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100dvh; }
        header { background: var(--primary); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        #app { flex: 1; display: flex; flex-direction: column; padding: 1rem; overflow-y: auto; }
        .card { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; margin-bottom: 1rem; }
        .word-de { font-size: 1.5rem; color: #666; }
        .controls { padding: 1rem; background: white; border-top: 1px solid #ddd; }
        .helper-bar { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }
        .helper-btn { padding: 10px 15px; font-size: 1.2rem; border: 1px solid #ccc; border-radius: 5px; background: #eee; }
        input { width: 100%; padding: 15px; font-size: 1.1rem; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .action-btn { width: 100%; padding: 15px; margin-top: 10px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1.1rem; }
        .hidden { display: none; }
        .feedback { margin-top: 10px; font-weight: bold; text-align: center; }
        #vocab-list div { border-bottom: 1px solid #eee; padding: 10px; display: flex; justify-content: space-between; align-items: center; background: white; margin-bottom: 5px; border-radius: 5px; }
		.progress-container {
			display: inline-flex;
			align-items: flex-end;
			gap: 3px;
			height: 20px;
			vertical-align: middle;
			margin-right: 8px;
		}
		.bar {
			width: 5px;
			background: #ccc;
			border-radius: 1px;
		}
		.bar1 { height: 6px; }
		.bar2 { height: 9px; }
		.bar3 { height: 12px; }
		.bar4 { height: 15px; }
		.bar5 { height: 18px; }
    </style>
</head>
<body>

<header>
    <div>
        <span id="stats">L√§dt...</span>
        <button onclick="forceUpdate()" style="background: #ff4444; color: white; border: none; padding: 5px 8px; border-radius: 5px; font-size: 0.7rem; margin-left: 10px;">Reset</button>
    </div>
    <button onclick="toggleView()" id="viewBtn">Vokabeln verwalten</button>
</header>

<div id="app">
    <div id="learn-view">
        <div class="card">
            <div id="direction-label" style="font-size: 0.8rem; color: var(--primary); margin-bottom: 5px;"></div>
            <div class="word-de" id="display-prompt">Bitte f√ºge Vokabeln hinzu!</div>
            <div id="feedback-area" class="feedback"></div>
        </div>
    </div>

    <div id="add-view" class="hidden">
        <h3>Neue Vokabel hinzuf√ºgen</h3>
        <input type="text" id="input-sv" placeholder="Schwedisch (z.B. √Ñpplet)" autocapitalize="sentences">
        <input type="text" id="input-de" placeholder="Deutsch (z.B. Der Apfel)" style="margin-top:10px" autocapitalize="sentences">
        <button class="action-btn" onclick="addVocab()">Speichern (Beide Richtungen)</button>
        
        <h3 style="margin-top:20px">Alle Vokabeln</h3>
        <div id="vocab-list"></div>
    </div>
</div>

<div class="controls" id="input-controls">
    <div class="helper-bar">
        <button class="helper-btn" onclick="addChar('√•')">√•</button>
        <button class="helper-btn" onclick="addChar('√§')">√§</button>
        <button class="helper-btn" onclick="addChar('√∂')">√∂</button>
    </div>
    <input type="text" id="user-input" placeholder="Antwort tippen..." autocomplete="off" autocapitalize="sentences">
    <button class="action-btn" id="check-btn" onclick="checkAnswer()">Pr√ºfen</button>
</div>

<script>
    const db = new Dexie('VocabTrainerDB');
    db.version(1).stores({ items: '++id, deckId, termSource, termTarget, direction, srs.dueDate' });

    let currentItem = null;

	function calculateSRS(item, quality) {
		let stage = (item.srs && item.srs.stage) ? item.srs.stage : 1;
		const intervals = { 1: 1, 2: 2, 3: 7, 4: 14, 5: 30, 6: 180 };

		if (quality >= 3) {
			stage = Math.min(6, stage + 1);
		} else {
			stage = 1;
		}

		const days = intervals[stage];
		const dueDate = Date.now() + days * 24 * 60 * 60 * 1000;
		return { stage, dueDate };
	}

    function getLevenshtein(a, b) {
        const matrix = [];
        for (let i = 0; i <= b.length; i++) matrix[i] = [i];
        for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
        for (let i = 1; i <= b.length; i++) {
            for (let j = 1; j <= a.length; j++) {
                if (b.charAt(i - 1) === a.charAt(j - 1)) matrix[i][j] = matrix[i - 1][j - 1];
                else matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j] + 1);
            }
        }
        return matrix[b.length][a.length];
    }

    function speak(text) {
        const ut = new SpeechSynthesisUtterance(text);
        ut.lang = 'sv-SE';
        ut.rate = 0.9;
        window.speechSynthesis.speak(ut);
    }

    async function loadNextItem() {
        const due = await db.items.where('srs.dueDate').below(Date.now()).toArray();
        const allCount = await db.items.count();
        document.getElementById('stats').innerText = `F√§llig: ${due.length} | Gesamt: ${allCount}`;

        if (allCount === 0) {
            document.getElementById('display-prompt').innerText = "Bitte Vokabeln hinzuf√ºgen!";
            return;
        }

        currentItem = due.length > 0 ? due[0] : null;
		if (currentItem) {
            // Wort anzeigen
            document.getElementById('display-prompt').innerText = currentItem.termSource;
            // Fortschrittsbalken und Richtung anzeigen
			const currentStage = (currentItem.srs && currentItem.srs.stage) ? currentItem.srs.stage : 1;
			document.getElementById('direction-label').innerHTML = 
			getProgressIcon(currentStage) + (currentItem.direction === 'de-sv' ? "DE ‚ûî SV" : "SV ‚ûî DE");
        } else {
            document.getElementById('display-prompt').innerText = "Alles erledigt! üéâ";
            document.getElementById('direction-label').innerText = "";
        }
        document.getElementById('user-input').value = "";
        document.getElementById('feedback-area').innerText = "";
    }

	async function checkAnswer() {
		if (!currentItem) return;
		const input = document.getElementById('user-input').value.trim();
		const target = currentItem.termTarget.trim();

		// "Null-Toleranz-Modus": Jeder Buchstabe (besonders √•, √§, √∂) muss exakt stimmen[cite: 124, 125, 126].
		// Wir nutzen .toLowerCase(), damit die automatische Gro√üschreibung am Handy
		// nicht als Fehler gewertet wird, aber Umlaute und Schreibweise sind nun strikt.
		const isCorrect = input.toLowerCase() === target.toLowerCase();

		// Bei Erfolg Stufe 5 (Aufstieg), bei kleinstem Fehler Stufe 0 (Reset auf Stufe 1) [cite: 107-112].
		let quality = isCorrect ? 5 : 0;
    
		await db.items.update(currentItem.id, { srs: calculateSRS(currentItem, quality) });
    
		// Sprachausgabe und Feedback
		if (currentItem.direction === 'de-sv') speak(currentItem.termTarget);
		else speak(currentItem.termSource);

		const feedback = document.getElementById('feedback-area');
		feedback.innerText = isCorrect ? `Richtig! (${target})` : `Falsch. L√∂sung: ${target}`;
		feedback.style.color = isCorrect ? "green" : "red";

		// Sperrt den Button kurz, um versehentliches √úberspringen zu verhindern
		document.getElementById('check-btn').disabled = true;
		setTimeout(() => {
			document.getElementById('check-btn').disabled = false;
			loadNextItem();
		}, 2000);
	}

	async function addVocab() {
		const sv = document.getElementById('input-sv').value.trim();
		const de = document.getElementById('input-de').value.trim();
		if (!de || !sv) return;

		const srsInit = () => ({ stage: 1, dueDate: 0 });

		await db.items.add({ deckId: 1, termSource: de, termTarget: sv, direction: 'de-sv', srs: srsInit() });
		await db.items.add({ deckId: 1, termSource: sv, termTarget: de, direction: 'sv-de', srs: srsInit() });

		document.getElementById('input-de').value = "";
		document.getElementById('input-sv').value = "";
		if (!document.getElementById('add-view').classList.contains('hidden')) renderList();
		await loadNextItem(); 
	}

    async function renderList() {
        const items = await db.items.toArray();
        document.getElementById('vocab-list').innerHTML = items.map(i => `
            <div>
				<span>${getProgressIcon(i.srs.stage || 1)} <strong>${i.termSource}</strong> - ${i.termTarget}</span>
                <button onclick="deleteVocab(${i.id})" style="background:#ff4444; color:white; border:none; padding:5px; border-radius:3px;">X</button>
            </div>
        `).join('');
    }

    async function deleteVocab(id) {
        if (confirm("L√∂schen?")) { await db.items.delete(id); renderList(); loadNextItem(); }
    }

    function addChar(c) { const i = document.getElementById('user-input'); i.value += c; i.focus(); }

    function toggleView() {
        const addView = document.getElementById('add-view');
        const isNowHidden = addView.classList.toggle('hidden');
        
        document.getElementById('learn-view').classList.toggle('hidden', !isNowHidden);
        document.getElementById('input-controls').classList.toggle('hidden', !isNowHidden);
        document.getElementById('viewBtn').innerText = isNowHidden ? "Vokabeln verwalten" : "Zum Lernen";
        
        if (!isNowHidden) renderList();
    }

    async function forceUpdate() {
        if (confirm("Reset? Datenbank bleibt erhalten, Cache wird geleert.")) {
            const regs = await navigator.serviceWorker.getRegistrations();
            for (let r of regs) await r.unregister();
            const keys = await caches.keys();
            await Promise.all(keys.map(k => caches.delete(k)));
            window.location.reload(true);
        }
    }

	function getProgressIcon(stage = 1) {
		const colors = ['#ff4444', '#ffbb33', '#ffeb3b', '#90EE90', '#006400'];
		let html = '<div class="progress-container">';
		for (let i = 1; i <= 5; i++) {
			const color = (stage > i) ? colors[i-1] : '#ccc';
			html += `<div class="bar bar${i}" style="background: ${color}"></div>`;
		}
		html += '</div>';
		return html;
	}

    loadNextItem();
</script>

</body>
</html>