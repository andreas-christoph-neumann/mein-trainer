<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
    <title>Svenska Trainer</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        :root { --primary: #0051a8; --accent: #ffcd00; --bg: #f4f4f4; --grammar: #7f8c8d; --style: #d35400; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100dvh; }
        header { background: var(--primary); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        #app { flex: 1; display: flex; flex-direction: column; padding: 1rem; overflow-y: auto; }
        .card { background: white; padding: 1.5rem; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; margin-bottom: 1rem; }
        .word-prompt { font-size: 1.8rem; font-weight: bold; color: #333; margin-bottom: 5px; }
        .badge-container { display: flex; justify-content: center; gap: 4px; flex-wrap: wrap; margin-top: 8px; }
        .badge { padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; color: white; font-weight: bold; text-transform: uppercase; }
        .bg-grammar { background-color: var(--grammar); }
        .bg-style { background-color: var(--style); }
        .controls { padding: 1rem; background: white; border-top: 1px solid #ddd; }
        .helper-bar { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }
        .helper-btn { padding: 8px 12px; font-size: 1rem; border: 1px solid #ccc; border-radius: 5px; background: #eee; }
        input { width: 100%; padding: 10px; font-size: 1rem; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 5px; }
        .action-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1.1rem; }
        .hidden { display: none; }
        #vocab-list .vocab-item { border-bottom: 1px solid #eee; padding: 10px; background: white; margin-bottom: 5px; border-radius: 5px; }
        .search-box { margin-bottom: 15px; border-color: var(--primary); }
        .inline-edit-box { display: flex; flex-direction: column; gap: 5px; background: #fffde7; padding: 10px; border: 1px solid var(--accent); border-radius: 8px; }
        .inline-edit-box input { font-size: 0.9rem; padding: 6px; }
        .inline-btn-group { display: flex; gap: 5px; }
        .inline-btn { flex: 1; padding: 8px; border-radius: 5px; border: none; font-size: 0.8rem; cursor: pointer; }
        .save-btn { background: #4caf50; color: white; }
        .cancel-btn { background: #9e9e9e; color: white; }
        .list-btn { background: none; border: none; font-size: 1.1rem; cursor: pointer; padding: 5px; }
    </style>
</head>
<body>

<header>
    <div>
        <span id="stats">L√§dt...</span>
        <button onclick="location.reload(true)" style="background: #ff4444; color: white; border: none; padding: 5px 8px; border-radius: 5px; font-size: 0.7rem; margin-left: 10px;">Reset</button>
    </div>
    <button onclick="toggleView()" id="viewBtn">Vokabeln verwalten</button>
</header>

<div id="app">
    <div id="learn-view">
        <div class="card">
            <div id="direction-label" style="font-size: 0.9rem; color: var(--primary); margin-bottom: 8px;"></div>
            <div class="word-prompt" id="display-prompt">Bitte Vokabeln hinzuf√ºgen!</div>
            <div id="display-badges" class="badge-container"></div>
            <div id="display-sentence" style="font-style: italic; color: #666; margin-top: 10px;"></div>
            <div id="feedback-area" style="margin-top: 10px; font-weight: bold;"></div>
        </div>
    </div>

    <div id="add-view" class="hidden">
        <h3>Neue Vokabel hinzuf√ºgen</h3>
        <input type="text" id="input-sv" placeholder="Schwedisch">
        <input type="text" id="input-de" placeholder="Deutsch">
        <input type="text" id="input-tags" placeholder="Zusatzinfo (Komma getrennt)">
        <button class="action-btn" onclick="addVocab()">Speichern</button>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="action-btn" style="background:#666; font-size: 0.8rem;" onclick="exportData()">Export</button>
            <button class="action-btn" style="background:#666; font-size: 0.8rem;" onclick="document.getElementById('importFile').click()">Import</button>
            <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(event)">
        </div>

        <h3 style="margin-top:25px">Liste filtern</h3>
        <input type="text" id="search-input" class="search-box" placeholder="Suchen nach Wort oder Tag..." oninput="renderList()">
        <div id="vocab-list"></div>
    </div>
</div>

<div class="controls" id="input-controls">
    <div class="helper-bar">
        <button class="helper-btn" onclick="addChar('√•')">√•</button>
        <button class="helper-btn" onclick="addChar('√§')">√§</button>
        <button class="helper-btn" onclick="addChar('√∂')">√∂</button>
    </div>
    <input type="text" id="user-input" placeholder="Antwort..." autocomplete="off">
    <button class="action-btn" id="check-btn" onclick="checkAnswer()">Pr√ºfen</button>
</div>

<script>
    const db = new Dexie('VocabTrainerDB');
    db.version(1).stores({ items: '++id, termSource, termTarget, direction, tags, srs.dueDate' });

    let currentItem = null;
    let inlineEditingId = null;

    function calculateSRS(item, correct) {
        let stage = (item.srs && item.srs.stage) ? item.srs.stage : 1;
        stage = correct ? Math.min(6, stage + 1) : 1;
        const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        let days = stage === 1 ? 1 : stage === 2 ? 2 : stage === 3 ? rand(6, 8) : stage === 4 ? rand(12, 16) : stage === 5 ? rand(25, 35) : rand(150, 200);
        return { stage, dueDate: Date.now() + (days * 24 * 60 * 60 * 1000) };
    }

    function speak(text) {
        const ut = new SpeechSynthesisUtterance(text.split('/')[0]);
        ut.lang = 'sv-SE';
        ut.rate = 0.9;
        window.speechSynthesis.speak(ut);
    }

    function getProgressIcon(stage = 1) {
        const colors = ['#ff4444', '#ffbb33', '#ffeb3b', '#90EE90', '#006400'];
        let svg = `<svg width="14" height="8" viewBox="0 0 7 4" style="vertical-align: middle; margin-right: 6px;">`;
        for (let i = 0; i < 5; i++) {
            svg += `<rect x="${i * 1.4}" y="${4 - (i + 1) * 0.8}" width="0.8" height="${(i + 1) * 0.8}" fill="${stage > i + 1 ? colors[i] : '#ccc'}" />`;
        }
        return svg + `</svg>`;
    }

    function renderBadges(tags) {
        if (!tags) return "";
        const styleKeys = ['ugs.', 'formell', 'slang'];
        return tags.split(',').map(t => {
            const isStyle = styleKeys.some(k => t.trim().toLowerCase().includes(k));
            return `<span class="badge ${isStyle ? 'bg-style' : 'bg-grammar'}">${t.trim()}</span>`;
        }).join('');
    }

    async function loadNextItem() {
        const due = await db.items.where('srs.dueDate').below(Date.now()).toArray();
        const allCount = await db.items.count();
        document.getElementById('stats').innerText = `F√§llig: ${due.length} | Gesamt: ${allCount}`;
        
        // Eingabefeld und Feedback leeren
        document.getElementById('user-input').value = ""; 
        document.getElementById('feedback-area').innerText = "";

        currentItem = due.length > 0 ? due[Math.floor(Math.random() * due.length)] : null;
        if (currentItem) {
            document.getElementById('display-prompt').innerText = currentItem.termSource;
            document.getElementById('display-badges').innerHTML = renderBadges(currentItem.tags);
            document.getElementById('direction-label').innerHTML = getProgressIcon(currentItem.srs.stage) + (currentItem.direction === 'de-sv' ? "DE ‚ûî SV" : "SV ‚ûî DE");
        } else {
            document.getElementById('display-prompt').innerText = allCount > 0 ? "Pause! üéâ" : "Vokabeln hinzuf√ºgen!";
            document.getElementById('display-badges').innerHTML = "";
            document.getElementById('direction-label').innerHTML = "";
        }
    }

    async function checkAnswer() {
        if (!currentItem) return;
        const input = document.getElementById('user-input').value.trim().toLowerCase();
        const targets = currentItem.termTarget.split('/').map(t => t.trim().toLowerCase());
        const isCorrect = targets.includes(input);
        
        await db.items.update(currentItem.id, { srs: calculateSRS(currentItem, isCorrect) });
        
        // Sprachausgabe bei korrekter Richtung
        if (currentItem.direction === 'de-sv') speak(currentItem.termTarget);
        else speak(currentItem.termSource);

        const feedback = document.getElementById('feedback-area');
        feedback.innerText = isCorrect ? "Richtig!" : `Falsch: ${currentItem.termTarget}`;
        feedback.style.color = isCorrect ? "green" : "red";
        
        setTimeout(loadNextItem, 1500);
    }

    async function addVocab(data = null) {
        const sv = data ? data.sv : document.getElementById('input-sv').value.trim();
        const de = data ? data.de : document.getElementById('input-de').value.trim();
        const tags = data ? data.tags : document.getElementById('input-tags').value.trim();
        if (!sv || !de) return;
        const srs = { stage: 1, dueDate: 0 };
        await db.items.add({ termSource: de, termTarget: sv, direction: 'de-sv', tags, srs });
        await db.items.add({ termSource: sv, termTarget: de, direction: 'sv-de', tags, srs });
        if (!data) { document.getElementById('input-sv').value = ""; document.getElementById('input-de').value = ""; document.getElementById('input-tags').value = ""; }
        renderList(); loadNextItem();
    }

    async function renderList() {
        const query = document.getElementById('search-input').value.toLowerCase();
        let items = await db.items.toArray();
        if (query) {
            items = items.filter(i => i.termSource.toLowerCase().includes(query) || i.termTarget.toLowerCase().includes(query) || (i.tags && i.tags.toLowerCase().includes(query)));
        }
        const container = document.getElementById('vocab-list');
        container.innerHTML = items.map(i => {
            if (inlineEditingId === i.id) {
                return `
                <div class="vocab-item inline-edit-box">
                    <input type="text" id="edit-src-${i.id}" value="${i.termSource}">
                    <input type="text" id="edit-trg-${i.id}" value="${i.termTarget}">
                    <input type="text" id="edit-tags-${i.id}" value="${i.tags || ''}">
                    <div class="inline-btn-group">
                        <button class="inline-btn save-btn" onclick="saveInline(${i.id})">Speichern</button>
                        <button class="inline-btn cancel-btn" onclick="cancelInline()">Abbruch</button>
                    </div>
                </div>`;
            }
            return `
            <div class="vocab-item" style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div>${getProgressIcon(i.srs.stage)} <strong>${i.termSource}</strong> - ${i.termTarget}</div>
                    <div style="margin-top:4px;">${renderBadges(i.tags)}</div>
                </div>
                <div>
                    <button class="list-btn" onclick="startInline(${i.id})">‚úé</button>
                    <button class="list-btn" onclick="deleteVocab(${i.id})" style="color:red;">‚úï</button>
                </div>
            </div>`;
        }).join('');
    }

    function startInline(id) { inlineEditingId = id; renderList(); }
    function cancelInline() { inlineEditingId = null; renderList(); }
    async function saveInline(id) {
        const termSource = document.getElementById(`edit-src-${id}`).value.trim();
        const termTarget = document.getElementById(`edit-trg-${id}`).value.trim();
        const tags = document.getElementById(`edit-tags-${id}`).value.trim();
        await db.items.update(id, { termSource, termTarget, tags });
        inlineEditingId = null;
        renderList(); loadNextItem();
    }

    async function deleteVocab(id) { if (confirm("L√∂schen?")) { await db.items.delete(id); renderList(); loadNextItem(); } }
    async function exportData() { const items = await db.items.toArray(); const blob = new Blob([JSON.stringify(items)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'backup.json'; a.click(); }
    async function importData(e) { const reader = new FileReader(); reader.onload = async (event) => { const data = JSON.parse(event.target.result); await db.items.bulkAdd(data); renderList(); loadNextItem(); }; reader.readAsText(e.target.files[0]); }
    function addChar(c) { const i = document.getElementById('user-input'); i.value += c; i.focus(); }
    
    function toggleView() { 
        const isHidden = document.getElementById('add-view').classList.toggle('hidden'); 
        document.getElementById('learn-view').classList.toggle('hidden'); 
        document.getElementById('input-controls').classList.toggle('hidden'); 
        
        // Button-Text dynamisch anpassen
        document.getElementById('viewBtn').innerText = isHidden ? "Vokabeln verwalten" : "Vokabeln abfragen";
        renderList(); 
    }

    loadNextItem();
</script>
</body>
</html>