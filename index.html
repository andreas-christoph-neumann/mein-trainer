<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
    <title>Svenska Trainer</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        :root { --primary: #0051a8; --accent: #ffcd00; --bg: #f4f4f4; --grammar: #7f8c8d; --style: #d35400; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100dvh; }
        header { background: var(--primary); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        
        #app { flex: 1; display: flex; flex-direction: column; padding: 1rem; overflow-y: auto; }
        .card { background: white; padding: 1.5rem; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; margin-bottom: 1rem; }
        .word-prompt { font-size: 1.8rem; font-weight: bold; color: #333; margin-bottom: 5px; }
        .sentence-hint { font-size: 1rem; color: #666; font-style: italic; min-height: 1.2rem; margin-top: 5px; }
        
        /* Badge Styles */
        .badge-container { display: flex; justify-content: center; gap: 4px; flex-wrap: wrap; margin-top: 8px; }
        .badge { padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; color: white; font-weight: bold; text-transform: uppercase; }
        .bg-grammar { background-color: var(--grammar); }
        .bg-style { background-color: var(--style); }

        .controls { padding: 1rem; background: white; border-top: 1px solid #ddd; }
        .helper-bar { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }
        .helper-btn { padding: 10px 15px; font-size: 1.2rem; border: 1px solid #ccc; border-radius: 5px; background: #eee; }
        input { width: 100%; padding: 12px; font-size: 1rem; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .action-btn { width: 100%; padding: 15px; margin-top: 10px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1.1rem; }
        
        .hidden { display: none; }
        .feedback { margin-top: 10px; font-weight: bold; text-align: center; }
        #vocab-list div { border-bottom: 1px solid #eee; padding: 10px; background: white; margin-bottom: 5px; border-radius: 5px; }
        
        .edit-btn { background: var(--accent); color: #333; border: none; padding: 5px 8px; border-radius: 3px; font-size: 0.8rem; margin-right: 5px; cursor: pointer; display: inline-flex; align-items: center; }
        .delete-btn { background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 3px; font-size: 0.8rem; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <div>
        <span id="stats">L√§dt...</span>
        <button onclick="forceUpdate()" style="background: #ff4444; color: white; border: none; padding: 5px 8px; border-radius: 5px; font-size: 0.7rem; margin-left: 10px;">Reset</button>
    </div>
    <button onclick="toggleView()" id="viewBtn">Vokabeln verwalten</button>
</header>

<div id="app">
    <div id="learn-view">
        <div class="card">
            <div id="direction-label" style="font-size: 0.9rem; color: var(--primary); margin-bottom: 8px; display: flex; align-items: center; justify-content: center;"></div>
            <div class="word-prompt" id="display-prompt">Bitte Vokabeln hinzuf√ºgen!</div>
            <div id="display-badges" class="badge-container"></div>
            <div class="sentence-hint" id="display-sentence"></div>
            <div id="feedback-area" class="feedback"></div>
        </div>
    </div>

    <div id="add-view" class="hidden">
        <h3 id="form-title">Neue Vokabel hinzuf√ºgen</h3>
        <input type="text" id="input-sv" placeholder="Schwedisches Wort" autocapitalize="sentences">
        <input type="text" id="input-sent-sv" placeholder="Schwedischer Beispielsatz (optional)" style="margin-top:5px; font-size: 0.9rem;" autocapitalize="sentences">
        
        <input type="text" id="input-de" placeholder="Deutsche Bedeutung" style="margin-top:15px" autocapitalize="sentences">
        <input type="text" id="input-sent-de" placeholder="Deutscher Beispielsatz (optional)" style="margin-top:5px; font-size: 0.9rem;" autocapitalize="sentences">
        
        <input type="text" id="input-tags" placeholder="Zusatzinfo (z.B. 3. Deklination, ugs.)" style="margin-top:15px; border-color: var(--grammar);" autocapitalize="none">
        
        <button class="action-btn" id="save-vocab-btn" onclick="addVocab()">Speichern (Beide Richtungen)</button>
        <button class="action-btn hidden" id="cancel-edit-btn" onclick="resetForm()" style="background: #888; margin-top: 5px;">Abbrechen</button>
        
        <h3 style="margin-top:25px">Alle Vokabeln</h3>
        <div id="vocab-list"></div>
    </div>
</div>

<div class="controls" id="input-controls">
    <div class="helper-bar">
        <button class="helper-btn" onclick="addChar('√•')">√•</button>
        <button class="helper-btn" onclick="addChar('√§')">√§</button>
        <button class="helper-btn" onclick="addChar('√∂')">√∂</button>
    </div>
    <input type="text" id="user-input" placeholder="Antwort tippen..." autocomplete="off" autocapitalize="sentences">
    <button class="action-btn" id="check-btn" onclick="checkAnswer()">Pr√ºfen</button>
</div>

<script>
    const db = new Dexie('VocabTrainerDB');
    db.version(1).stores({ items: '++id, deckId, termSource, termTarget, direction, srs.dueDate' });

    let currentItem = null;
    let editingId = null;

    function calculateSRS(item, quality) {
        let stage = (item.srs && item.srs.stage) ? item.srs.stage : 1;
        if (quality >= 3) { stage = Math.min(6, stage + 1); } else { stage = 1; }
        
        let days;
        const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

        switch (stage) {
            case 1: days = 1; break;
            case 2: days = 2; break;
            case 3: days = rand(6, 8); break;
            case 4: days = rand(12, 16); break;
            case 5: days = rand(25, 35); break;
            case 6: days = rand(150, 200); break;
            default: days = 1;
        }

        const dueDate = Date.now() + (days * 24 * 60 * 60 * 1000);
        return { stage, dueDate };
    }

    function speak(text) {
        const ut = new SpeechSynthesisUtterance(text);
        ut.lang = 'sv-SE';
        ut.rate = 0.9;
        window.speechSynthesis.speak(ut);
    }

    // Wandelt Komma-Text in farbige Badges um
    function renderBadges(tagsString) {
        if (!tagsString) return "";
        const styleKeywords = ['ugs.', 'formell', 'slang', 'fam.', 'poet.', 'arch.', 'lit.'];
        return tagsString.split(',').map(tag => {
            const t = tag.trim();
            if (!t) return "";
            const isStyle = styleKeywords.some(k => t.toLowerCase().includes(k));
            return `<span class="badge ${isStyle ? 'bg-style' : 'bg-grammar'}">${t}</span>`;
        }).join('');
    }

    function getProgressIcon(stage = 1) {
        const colors = ['#ff4444', '#ffbb33', '#ffeb3b', '#90EE90', '#006400'];
        let svg = `<svg width="14" height="8" viewBox="0 0 7 4" style="vertical-align: middle; margin-right: 6px; shape-rendering: crispEdges;">`;
        for (let i = 0; i < 5; i++) {
            const color = (stage > i + 1) ? colors[i] : '#ccc';
            const h = (i + 1) * 0.8;
            svg += `<rect x="${i * 1.4}" y="${4 - h}" width="0.8" height="${h}" fill="${color}" />`;
        }
        svg += `</svg>`;
        return svg;
    }

    async function loadNextItem() {
        const due = await db.items.where('srs.dueDate').below(Date.now()).toArray();
        const allCount = await db.items.count();
        document.getElementById('stats').innerText = `F√§llig: ${due.length} | Gesamt: ${allCount}`;

        if (allCount === 0) {
            document.getElementById('display-prompt').innerText = "Bitte Vokabeln hinzuf√ºgen!";
            document.getElementById('display-sentence').innerText = "";
            document.getElementById('display-badges').innerHTML = "";
            return;
        }

        currentItem = due.length > 0 ? due[Math.floor(Math.random() * due.length)] : null;

        if (currentItem) {
            document.getElementById('display-prompt').innerText = currentItem.termSource;
            document.getElementById('display-sentence').innerText = currentItem.sentenceSource || "";
            document.getElementById('display-badges').innerHTML = renderBadges(currentItem.tags);
            
            const currentStage = (currentItem.srs && currentItem.srs.stage) ? currentItem.srs.stage : 1;
            document.getElementById('direction-label').innerHTML = 
                getProgressIcon(currentStage) + "<span>" + (currentItem.direction === 'de-sv' ? "DE ‚ûî SV" : "SV ‚ûî DE") + "</span>";
        } else {
            document.getElementById('display-prompt').innerText = "Alles erledigt! üéâ";
            document.getElementById('display-sentence').innerText = "";
            document.getElementById('display-badges').innerHTML = "";
            document.getElementById('direction-label').innerHTML = "";
        }
        document.getElementById('user-input').value = "";
        document.getElementById('feedback-area').innerText = "";
    }

    async function checkAnswer() {
        if (!currentItem) return;
        const input = document.getElementById('user-input').value.trim().toLowerCase();
        const target = currentItem.termTarget.trim().toLowerCase();
        const isCorrect = input === target;

        await db.items.update(currentItem.id, { srs: calculateSRS(currentItem, isCorrect ? 5 : 0) });
        if (currentItem.direction === 'de-sv') speak(currentItem.termTarget);
        else speak(currentItem.termSource);

        const feedback = document.getElementById('feedback-area');
        feedback.innerText = isCorrect ? `Richtig! (${currentItem.termTarget})` : `Falsch. L√∂sung: ${currentItem.termTarget}`;
        feedback.style.color = isCorrect ? "green" : "red";

        document.getElementById('check-btn').disabled = true;
        setTimeout(() => {
            document.getElementById('check-btn').disabled = false;
            loadNextItem();
        }, 2000);
    }

    async function addVocab() {
        const sv = document.getElementById('input-sv').value.trim();
        const de = document.getElementById('input-de').value.trim();
        const sentSv = document.getElementById('input-sent-sv').value.trim();
        const sentDe = document.getElementById('input-sent-de').value.trim();
        const tags = document.getElementById('input-tags').value.trim();
        
        if (!de || !sv) return;

        if (editingId) {
            const isDeSv = document.getElementById('form-title').innerText.includes("DE-SV") || document.getElementById('form-title').innerText.includes("DE ‚ûî SV");
            await db.items.update(editingId, {
                termSource: isDeSv ? de : sv,
                termTarget: isDeSv ? sv : de,
                sentenceSource: isDeSv ? sentDe : sentSv,
                sentenceTarget: isDeSv ? sentSv : sentDe,
                tags: tags
            });
            resetForm();
        } else {
            const srsInit = () => ({ stage: 1, dueDate: 0 });
            await db.items.add({ deckId: 1, termSource: de, termTarget: sv, sentenceSource: sentDe, sentenceTarget: sentSv, tags: tags, direction: 'de-sv', srs: srsInit() });
            await db.items.add({ deckId: 1, termSource: sv, termTarget: de, sentenceSource: sentSv, sentenceTarget: sentDe, tags: tags, direction: 'sv-de', srs: srsInit() });
            resetForm();
        }
        renderList();
        loadNextItem();
    }

    async function editVocab(id) {
        const item = await db.items.get(id);
        if (!item) return;
        editingId = id;
        const isDeSv = item.direction === 'de-sv';
        document.getElementById('input-sv').value = isDeSv ? item.termTarget : item.termSource;
        document.getElementById('input-de').value = isDeSv ? item.termSource : item.termTarget;
        document.getElementById('input-sent-sv').value = isDeSv ? item.sentenceTarget : item.sentenceSource;
        document.getElementById('input-sent-de').value = isDeSv ? item.sentenceSource : item.sentenceTarget;
        document.getElementById('input-tags').value = item.tags || "";
        
        document.getElementById('form-title').innerText = `Vokabel editieren (${item.direction.toUpperCase()})`;
        document.getElementById('save-vocab-btn').innerText = "√Ñnderungen speichern";
        document.getElementById('cancel-edit-btn').classList.remove('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetForm() {
        editingId = null;
        document.getElementById('input-sv').value = "";
        document.getElementById('input-de').value = "";
        document.getElementById('input-sent-sv').value = "";
        document.getElementById('input-sent-de').value = "";
        document.getElementById('input-tags').value = "";
        document.getElementById('form-title').innerText = "Neue Vokabel hinzuf√ºgen";
        document.getElementById('save-vocab-btn').innerText = "Speichern (Beide Richtungen)";
        document.getElementById('cancel-edit-btn').classList.add('hidden');
    }

    async function renderList() {
        const items = await db.items.toArray();
        document.getElementById('vocab-list').innerHTML = items.map(i => `
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <div style="display: flex; align-items: baseline; line-height: 1.2; flex-wrap: wrap; gap: 4px;">
                        ${getProgressIcon(i.srs.stage || 1)} 
                        <strong>${i.termSource}</strong> - ${i.termTarget}
                        ${renderBadges(i.tags)}
                    </div>
                    <small style="color: #888; margin-left: 20px; display: block; line-height: 1.2;">${i.sentenceSource || ''}</small>
                </div>
                <div style="display: flex; gap: 5px;">
                    <button class="edit-btn" onclick="editVocab(${i.id})">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                    </button>
                    <button class="delete-btn" onclick="deleteVocab(${i.id})">X</button>
                </div>
            </div>
        `).join('');
    }

    async function deleteVocab(id) {
        if (confirm("L√∂schen?")) { await db.items.delete(id); renderList(); loadNextItem(); }
    }

    function addChar(c) { const i = document.getElementById('user-input'); i.value += c; i.focus(); }

    function toggleView() {
        const isNowHidden = document.getElementById('add-view').classList.toggle('hidden');
        document.getElementById('learn-view').classList.toggle('hidden', !isNowHidden);
        document.getElementById('input-controls').classList.toggle('hidden', !isNowHidden);
        document.getElementById('viewBtn').innerText = isNowHidden ? "Vokabeln verwalten" : "Zum Lernen";
        if (!isNowHidden) { resetForm(); renderList(); }
    }

    async function forceUpdate() {
        if (confirm("Reset? Cache wird geleert.")) {
            const regs = await navigator.serviceWorker.getRegistrations();
            for (let r of regs) await r.unregister();
            const keys = await caches.keys();
            await Promise.all(keys.map(k => caches.delete(k)));
            window.location.reload(true);
        }
    }

    loadNextItem();
</script>
</body>
</html>